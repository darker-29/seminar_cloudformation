AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parmeters:
  Env:
    Type: String
    Default: test
  TargetBranch:
    Type: String
    Default: test

Resources:
  Repository:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: !Sub ${Env}-app
      RepositoryDescription: !Sub ${Env} Application Repository
      Code:
        BranchName: !Ref TargetBranch
      Tags:
        - Key: Name
          Value: !Sub ${Env}-app

  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${Env}-codepipeline
      RestartExecutionOnUpdate: false
      ArtifactStore:
        Type: S3
        Location: 
          Fn::ImportValue:
            !Sub ${Env}-artifact
            #EncryptionKey:
            #  Id: CHANGEME
            #  Type: KMS
      RoleArn: CHANGEME
      Stages:
        - Name: !Sub ${Env}-source
          Actions:
            - Name: !Sub ${Env}-source
              Namespace: App
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeCommit
                Version: 1
              Configuration:
                RepositoryName: !Ref Repository
                BranchName: !Ref TargetBranch
                PollForSourceChanges: false
                OutputArtifactFormat: CODE_ZIP
              OutputArtifacts:
                - Name: !Sub ${Env}-source
              Region: AWS::Region
              RunOrder: 1
        - Name: !Sub ${Env}-build
          Actions:
            - Name: !Sub ${Env}-build
              Namespace: App
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuild
                BatchEnabled: false
              InputArtifacts:
                - Name: !Sub ${Env}-source
              OutputArtifacts:
                - Name: !Sub ${Env}-build
              Region: AWS::Region
              RunOrder: 1
        - Name: !Sub ${Env}-test
          Actions:
            - Name: !Sub ${Env}-test
              Namespace: App
              ActionTypeId:
                Category: Test
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration: '{"JSON": "CHANGEME"}' # Optional
              InputArtifacts:
                - Name: !Sub ${Env}-build
              OutputArtifacts:
                - Name: !Sub ${Env}-test
              Region: AWS::Region
              RunOrder: 1
        - Name: !Sub ${Env}-deploy
          Actions:
            - Name: !Sub ${Env}-deploy
              Namespace: App
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CodeDeploy
                Version: 1
              Configuration: '{"JSON": "CHANGEME"}' # Optional
              InputArtifacts:
                - Name: !Sub ${Env}-test
              OutputArtifacts:
                - Name: !Sub ${Env}-deploy
              Region: AWS::Region
              RunOrder: 1
      Tags:
        - Key: Name
          Value: !Sub ${Env}-codepipeline

  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        ArtifactIdentifier: CHANGEME # Optional
        EncryptionDisabled: false # Optional
        Location: CHANGEME # Optional
        Name: CHANGEME # Optional
        NamespaceType: CHANGEME # Optional
        OverrideArtifactName: false # Optional
        Packaging: CHANGEME # Optional
        Path: CHANGEME # Optional
        Type: CHANGEME
      BadgeEnabled: false # Optional
      BuildBatchConfig: # Optional
        CombineArtifacts: false # Optional
        Restrictions: # Optional
          ComputeTypesAllowed: # Optional
            - CHANGEME
          MaximumBuildsAllowed: 0 # Optional
        ServiceRole: CHANGEME # Optional
        TimeoutInMins: 0 # Optional
      Cache: # Optional
        Location: CHANGEME # Optional
        Modes: # Optional
          - CHANGEME
        Type: CHANGEME
      ConcurrentBuildLimit: 0 # Optional
      Description: CHANGEME # Optional
      EncryptionKey: CHANGEME # Optional
      Environment:
        Certificate: CHANGEME # Optional
        ComputeType: CHANGEME
        EnvironmentVariables: # Optional
          - Name: CHANGEME
            Type: CHANGEME # Optional
            Value: CHANGEME
        Image: CHANGEME
        ImagePullCredentialsType: CHANGEME # Optional
        PrivilegedMode: false # Optional
        RegistryCredential: # Optional
          Credential: CHANGEME
          CredentialProvider: CHANGEME
        Type: CHANGEME
      FileSystemLocations:
        - Identifier: CHANGEME
          Location: CHANGEME
          MountOptions: CHANGEME # Optional
          MountPoint: CHANGEME
          Type: CHANGEME
      LogsConfig: # Optional
        CloudWatchLogs: # Optional
          GroupName: CHANGEME # Optional
          Status: CHANGEME
          StreamName: CHANGEME # Optional
        S3Logs: # Optional
          EncryptionDisabled: false # Optional
          Location: CHANGEME # Optional
          Status: CHANGEME
      Name: CHANGEME # Optional
      QueuedTimeoutInMinutes: 0 # Optional
      SecondaryArtifacts:
        - ArtifactIdentifier: CHANGEME # Optional
          EncryptionDisabled: false # Optional
          Location: CHANGEME # Optional
          Name: CHANGEME # Optional
          NamespaceType: CHANGEME # Optional
          OverrideArtifactName: false # Optional
          Packaging: CHANGEME # Optional
          Path: CHANGEME # Optional
          Type: CHANGEME
      SecondarySourceVersions:
        - SourceIdentifier: CHANGEME
          SourceVersion: CHANGEME # Optional
      SecondarySources:
        - Auth: # Optional
            Resource: CHANGEME # Optional
            Type: CHANGEME
          BuildSpec: CHANGEME # Optional
          BuildStatusConfig: # Optional
            Context: CHANGEME # Optional
            TargetUrl: CHANGEME # Optional
          GitCloneDepth: 0 # Optional
          GitSubmodulesConfig: # Optional
            FetchSubmodules: false
          InsecureSsl: false # Optional
          Location: CHANGEME # Optional
          ReportBuildStatus: false # Optional
          SourceIdentifier: CHANGEME # Optional
          Type: CHANGEME
      ServiceRole: CHANGEME
      Source:
        Auth: # Optional
          Resource: CHANGEME # Optional
          Type: CHANGEME
        BuildSpec: CHANGEME # Optional
        BuildStatusConfig: # Optional
          Context: CHANGEME # Optional
          TargetUrl: CHANGEME # Optional
        GitCloneDepth: 0 # Optional
        GitSubmodulesConfig: # Optional
          FetchSubmodules: false
        InsecureSsl: false # Optional
        Location: CHANGEME # Optional
        ReportBuildStatus: false # Optional
        SourceIdentifier: CHANGEME # Optional
        Type: CHANGEME
      SourceVersion: CHANGEME # Optional
      Tags:
        - Key: CHANGEME
          Value: CHANGEME
      TimeoutInMinutes: 0 # Optional
      Triggers: # Optional
        BuildType: CHANGEME # Optional
        FilterGroups: # Optional
          - - ExcludeMatchedPattern: false # Optional
              Pattern: CHANGEME
              Type: CHANGEME
        Webhook: false # Optional
      VpcConfig: # Optional
        SecurityGroupIds: # Optional
          - CHANGEME
        Subnets: # Optional
          - CHANGEME
        VpcId: CHANGEME # Optional




