AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Env:
    Type: String
    Default: test

Resources:
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${Env}-alb
      Type: alb
      IpAddressType: dualstack
      SecurityGroups:
        - Fn::ImportValue:
            !Sub ${Env}-ALBSecurityGroup
      Subnets:
        - Fn::ImportValue:
            !Sub ${Env}-PublicSubnet1a
        - Fn::ImportValue:
            !Sub ${Env}-PublicSubnet1c
      Tags:
        - Key: Name
          Value: !Sub ${Env}-alb

  ALB80Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: CHANGEME
          ForwardConfig: # Optional
            TargetGroupStickinessConfig: # Optional
              DurationSeconds: 0 # Optional
              Enabled: false # Optional
            TargetGroups: # Optional
              - TargetGroupArn: CHANGEME # Optional
                Weight: 0 # Optional
          Order: 0 # Optional

  ALB443Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      SslPolicy: CHANGEME # Optional
      Certificates:
        - CertificateArn:
            Fn::ImportValue:
              !Sub ${Env}-Certificate
      DefaultActions:
        - Type: CHANGEME
          ForwardConfig: # Optional
            TargetGroupStickinessConfig: # Optional
              DurationSeconds: 0 # Optional
              Enabled: false # Optional
            TargetGroups: # Optional
              - TargetGroupArn: CHANGEME # Optional
                Weight: 0 # Optional
          Order: 0 # Optional

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${Env}-targetgroup
      VpcId:
        Fn::ImportValue:
          !Sub ${Env}-VpcId
      TargetType: CHANGEME # Optional
      Targets:
        - AvailabilityZone: CHANGEME # Optional
          Id: CHANGEME
          Port: 0 # Optional
      Protocol: HTTP
      ProtocolVersion: CHANGEME # Optional
      Port: 80
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 60
      HealthCheckPath: /healthcheck.php
      HealthCheckPort: 80
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 0
      Tags:
        - Key: Name
          Value: !Sub ${Env}-targetgroup

Outputs:
  ALBTargetGroup:
    Value: !Ref ALBTargetGroup
    Export:
      Name: !Sub ${Env}-ALBTargetGroup
